<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <meta name="baidu-site-verification" content="code-IgVCkP0vYS">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"ttestoo.github.io","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":true,"show_result":true,"style":"mac"},"back2top":{"enable":true,"sidebar":true,"scrollpercent":true},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="前言前段时间遇到通过分号绕过nginx层屏蔽并顺利访问到Springboot项目actuator端点的问题，修复过程中偶然发现当项目使用shiro组件时，若将shiro升级到1.6.0可间接修复分号绕过的问题，当请求url中包含分号时响应状态码为400； 考虑到shiro主要用来执行身份验证授权等，理论上不适合直接阻断存在分号的请求； 为搞明白此问题，决定对shiro的权限校验问题进行整理学习，下">
<meta property="og:type" content="article">
<meta property="og:title" content="Shiro权限绕过漏洞分析">
<meta property="og:url" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/index.html">
<meta property="og:site_name" content="ttestoo&#39;s blog">
<meta property="og:description" content="前言前段时间遇到通过分号绕过nginx层屏蔽并顺利访问到Springboot项目actuator端点的问题，修复过程中偶然发现当项目使用shiro组件时，若将shiro升级到1.6.0可间接修复分号绕过的问题，当请求url中包含分号时响应状态码为400； 考虑到shiro主要用来执行身份验证授权等，理论上不适合直接阻断存在分号的请求； 为搞明白此问题，决定对shiro的权限校验问题进行整理学习，下">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630601325451-04629821-65ed-471b-947b-4c81084e2f7d.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630601529024-db7cbbd3-82f0-4a60-bbcc-02d89b72c644.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630739834223-12be9559-a876-4d95-9a34-ffca25c551d0.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630745912353-36615797-cdc2-4c85-9406-65cc1b36b08e.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630602160374-5ee7637f-d8db-4fc6-942b-2a43bb7c84b5.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630745201705-2b578d6d-186a-4b33-bdaa-6d76fd754fb0.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630747870669-5bec76ce-d2b0-481c-9019-a801c96636db.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630747980904-c4effede-5d19-4eea-99b6-ff24130290fb.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630748012922-0ad22a7d-cb79-45c0-9f02-3df49c9d1309.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630598417492-4561d4bc-9933-433f-957f-cc6ef78f13a6.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630598478182-9242f04f-91cd-4862-9087-81641d6200a0.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630762530640-9240f5a9-83f9-41f9-9891-abf1a8248b5e.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630762717437-9403cbc3-dd56-4bc4-8d51-7cb65e28b9ec.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630809693985-1a62aed9-2987-4f6c-8df6-b5492f8f5aea.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630809932017-a60478de-c6e6-47f3-bc8f-25cc7b5a1d4d.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630810346400-879eb414-cd8f-4130-a358-0315b2784e05.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630810879658-6b556d3b-a3b0-4d1c-8b65-465ef7cede1b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630810949737-cb56d03b-6473-493d-a5f2-b88f0ad64bd2.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811094176-66d3450e-57ff-4e4d-aee4-c2415e56c08c.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811284815-537bd7e2-85b4-4377-9221-f42c5b2ca665.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811428049-15663115-be70-4f2d-ba24-666150d9c746.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811448669-b4aeb01a-827c-4092-a470-1d3bc08fa14b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811624029-06a2480f-8ff0-4c6f-96b6-2f5904c8288f.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811689283-2290f02b-09c1-4985-b2c1-51cdb50ed836.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811708232-9b04ba5d-e375-44de-8c35-43251c2934a2.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630812974042-0739a060-658e-457a-bc3e-0f0602260706.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814032639-f5384d69-548c-4915-885c-31f826e6f859.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814270890-44405c4d-f4b9-47aa-b06b-b1d3ec5bbbd1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630816294063-b78527a9-edf2-4d0e-8c9e-eee4f42fdbdd.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814552407-1b27fd57-a556-4d2d-9c66-c5e91c488858.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814571335-e2e07b55-4482-4841-926d-13d5065b460e.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814649876-ba27a14c-84b0-4bdd-8e20-17008abd1635.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630815007728-c38c58ba-f7c3-4841-956b-e5028e47109c.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630815019684-7b0f5c02-5b48-484d-8ed5-1bb2eb6ed332.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630815090450-f094f3f2-a50c-4d2f-88e7-45654e8d571c.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630816436686-6e9f82b5-e84e-4652-a15e-468f6e2d8d94.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827548330-2d757707-5a2e-4869-9664-78844963a702.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827589372-af31f5c6-ce38-47f5-be95-1a557000ade1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827738887-b16a24c8-efaf-47c9-aff1-d81d040f440c.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827874273-60cc455e-5d29-4744-b8e5-7a7c5f04b4a4.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630828216926-97b8f1d8-a233-4852-85ec-6100b1695544.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630828309858-4c7c4de8-c44b-4281-8f82-ff557a9eb5b3.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630831911543-0b43ee1e-c97e-4382-9741-fc73e15343c1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630832201301-def312c4-e2c9-440b-9470-f653d11e9696.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630940489631-023496e1-da98-4daa-86b7-4e2d53939ba7.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630940471598-992e754e-ad27-42b5-ae86-7b79efaf47d6.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943081582-4a5406f7-7533-4e7a-a414-f4314b535385.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943069710-d91ad7b5-98ce-4864-8e06-81a410b061ed.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630940944021-d49d2cef-30eb-4cb0-a7a4-dc0603c17fd8.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941027724-973768dc-9e6a-46b0-b481-808a3b53f17f.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941223066-8d5d3e15-7452-49a0-b799-145565974c95.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941153275-fc2938c5-1511-4b06-97c1-350a73103326.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941324744-5c33ef7a-a9ab-4eaf-848d-eb3724832e01.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630942588039-62813c12-4dce-4a19-9375-c57a7f035d18.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630942848484-fa4eaa47-4186-4d97-978e-318228a8fc9f.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943377680-412a48a6-4637-4769-9ff8-1c92799cd8b1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943877599-043d68cf-fa55-41d7-ad5a-513391047a04.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630944025834-d16b0083-2bdc-4ae8-bb0d-fa72de871d7b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945224378-2d1e0b77-3a46-45b0-9be4-e1de4c7dd9f2.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945471480-9b2c69b6-7236-45b2-af8b-bb738eca964e.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945918658-bc68c88c-1bbd-4399-a165-0c2308f7f888.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945886978-5a1d43ef-4ad2-4fbd-b8a7-8a80a0dc96d5.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630946332455-87612f5b-4980-4311-8cef-d7341c417640.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630946573355-ad67852b-6b2a-45e3-a820-9b9f9d91f063.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945886978-5a1d43ef-4ad2-4fbd-b8a7-8a80a0dc96d5.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631015122689-9c983628-67d6-429a-967e-99b8241626ff.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631016774926-e0e9794a-c036-4504-864c-0724ca37a648.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631017071477-240b1685-4392-4189-9005-958d8ab598a6.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631016949953-06a618cd-7d58-470b-b248-c494fc7cfe09.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631017977165-d54f4233-14af-4e29-8d1a-9a8f90ec19f1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631017989869-461680d9-2844-4576-aa34-8bf6c36856e1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032985598-c1571efc-1430-4ec5-8569-13b46c2e000b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631031284766-7164c5c7-22c1-4dfa-9f44-ad509acc3ea1.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631030626922-0b1a9ad0-4566-4348-b292-5fa49af55b7b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631030678981-ed418be6-7f82-40bf-a5fa-0b4ba1f73d4b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631030734899-ac7be7be-06e1-430a-af66-acd42f6f15b3.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631031176098-38e463df-f41a-47c9-9ee8-7de8e5c35d6b.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631033732679-a4573a8c-d7bd-4a66-870b-88150f854011.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631031744667-66687cb2-cbb1-4b5d-be6c-dfec6b0d648a.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032096847-7a430343-9821-4683-ae80-09d9a11988b6.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032525802-e06e9e7d-8f38-4801-bd27-dba6f81bc6fb.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032729912-0ed6f6cf-5e47-43fb-97f4-52bd13eedd7e.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631029386444-c211b447-fd1e-431f-afa8-bb5a2598b112.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631033244890-a4a94396-3bb2-4880-af91-b22c15d828b0.png">
<meta property="og:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631033830623-14cd2689-3898-4e84-ac70-29ab899bbdb9.png">
<meta property="article:published_time" content="2021-09-08T15:03:39.000Z">
<meta property="article:modified_time" content="2022-01-22T08:11:08.358Z">
<meta property="article:author" content="ttestoo">
<meta property="article:tag" content="Shiro">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630601325451-04629821-65ed-471b-947b-4c81084e2f7d.png">

<link rel="canonical" href="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Shiro权限绕过漏洞分析 | ttestoo's blog</title>
  


  <script>
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "https://hm.baidu.com/hm.js?2509b78f4891a940e38e443a10f826fa";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>




  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

<link rel="alternate" href="/atom.xml" title="ttestoo's blog" type="application/atom+xml">
</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">ttestoo's blog</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">领悟。</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档<span class="badge">6</span></a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>标签<span class="badge">9</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>关于</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜索..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="reading-progress-bar"></div>

  <a href="https://github.com/ttestoo" class="github-corner" title="Follow me on GitHub" aria-label="Follow me on GitHub" rel="noopener" target="_blank"><svg width="80" height="80" viewBox="0 0 250 250" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avator.jpg">
      <meta itemprop="name" content="ttestoo">
      <meta itemprop="description" content="不争">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="ttestoo's blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Shiro权限绕过漏洞分析
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2021-09-08 23:03:39" itemprop="dateCreated datePublished" datetime="2021-09-08T23:03:39+08:00">2021-09-08</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2022-01-22 16:11:08" itemprop="dateModified" datetime="2022-01-22T16:11:08+08:00">2022-01-22</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shiro/" itemprop="url" rel="index"><span itemprop="name">Shiro</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Shiro/Java-Sec/" itemprop="url" rel="index"><span itemprop="name">Java Sec</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>13 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>前段时间遇到通过分号绕过nginx层屏蔽并顺利访问到Springboot项目actuator端点的问题，修复过程中偶然发现当项目使用shiro组件时，若将shiro升级到1.6.0可间接修复分号绕过的问题，当请求url中包含分号时响应状态码为400；</p>
<p>考虑到shiro主要用来执行身份验证授权等，理论上不适合直接阻断存在分号的请求；</p>
<p>为搞明白此问题，决定对shiro的权限校验问题进行整理学习，下面为常见的shiro权限绕过漏洞分析修复过程。</p>
<blockquote>
<p>文章首发于安全客：<a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/253749">https://www.anquanke.com/post/id/253749</a></p>
</blockquote>
<h1 id="Shiro-Filter"><a href="#Shiro-Filter" class="headerlink" title="Shiro Filter"></a>Shiro Filter</h1><p>学习shiro权限绕过漏洞之前，有必要了解下shiro filter的过滤过程；</p>
<p>一个http请求过来，首先经过web容器的处理（这里默认为tomcat）被投放到相应的web应用，web应用会通过过滤器Filter链式的对http请求进行预处理，这里将会经过shiro的Filter（SpringShiroFilter）处理：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.core.ApplicationFilterChain#internalDoFilter --&gt; org.apache.shiro.web.servlet.OncePerRequestFilter#doFilter		--&gt;    </span><br><span class="line">org.apache.shiro.web.servlet.AbstractShiroFilter#doFilterInternal  --&gt;</span><br><span class="line">org.apache.shiro.web.servlet.AbstractShiroFilter#executeChain</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630601325451-04629821-65ed-471b-947b-4c81084e2f7d.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630601529024-db7cbbd3-82f0-4a60-bbcc-02d89b72c644.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630739834223-12be9559-a876-4d95-9a34-ffca25c551d0.png" alt="img"></p>
<p>shiro的Filter执行过会通过getExecutionChain()获取执行链并执行对应的doFilter函数：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630745912353-36615797-cdc2-4c85-9406-65cc1b36b08e.png" alt="img"></p>
<p>重点在获取chain的org.apache.shiro.web.servlet.AbstractShiroFilter#getExecutionChain中；</p>
<p>首先会尝试获取到在springboot启动时加载的shiro配置文件中配置的Shiro filterChains（resolver）并判断是否为null，当为null则返回原始过滤器链origChain，当不为空时则尝试通过org.apache.shiro.web.filter.mgt.FilterChainResolver#getChain方法根据当前请求的url使用Ant模式获取相应的拦截器链 FilterChain代理（resolved），否则返回原始过滤器链origChain：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> FilterChain <span class="title">getExecutionChain</span><span class="params">(ServletRequest request, ServletResponse response, FilterChain origChain)</span> </span>&#123;</span><br><span class="line">    FilterChain chain = origChain;</span><br><span class="line"></span><br><span class="line">    FilterChainResolver resolver = getFilterChainResolver();</span><br><span class="line">    <span class="keyword">if</span> (resolver == <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.debug(<span class="string">&quot;No FilterChainResolver configured.  Returning original FilterChain.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> origChain;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    FilterChain resolved = resolver.getChain(request, response, origChain);</span><br><span class="line">    <span class="keyword">if</span> (resolved != <span class="keyword">null</span>) &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;Resolved a configured FilterChain for the current request.&quot;</span>);</span><br><span class="line">        chain = resolved;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        log.trace(<span class="string">&quot;No FilterChain configured for the current request.  Using the default.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> chain;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630602160374-5ee7637f-d8db-4fc6-942b-2a43bb7c84b5.png" alt="img"></p>
<p>其中获取shiro对应的FilterChain代理是在org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain中完成，主要通过</p>
<p>获取所有的filter链（filterChainManager）及requestURI，并循环遍历filterChainManager进行匹配，当匹配时则直接返回相对应的FilterChain代理，否则返回null：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630745201705-2b578d6d-186a-4b33-bdaa-6d76fd754fb0.png" alt="img"></p>
<p>附上filterChainManager接口说明：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">FilterChainManager</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 得到注册的拦截器</span></span><br><span class="line">    <span class="function">Map&lt;String, Filter&gt; <span class="title">getFilters</span><span class="params">()</span></span>;</span><br><span class="line">       <span class="comment">// 获取拦截器链</span></span><br><span class="line">    <span class="function">NamedFilterList <span class="title">getChain</span><span class="params">(String chainName)</span></span>;</span><br><span class="line">    <span class="comment">// 是否有拦截器链</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">hasChains</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 得到所有拦截器链的名字</span></span><br><span class="line">    <span class="function">Set&lt;String&gt; <span class="title">getChainNames</span><span class="params">()</span></span>;</span><br><span class="line">    <span class="comment">// 使用指定的拦截器链代理原始拦截器链</span></span><br><span class="line">    <span class="function">FilterChain <span class="title">proxy</span><span class="params">(FilterChain original, String chainName)</span></span>;</span><br><span class="line">    <span class="comment">// 注册拦截器</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addFilter</span><span class="params">(String name, Filter filter)</span></span>;</span><br><span class="line">    <span class="comment">// 注册拦截器</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addFilter</span><span class="params">(String name, Filter filter, <span class="keyword">boolean</span> init)</span></span>;</span><br><span class="line">    <span class="comment">// 根据拦截器链定义创建拦截器链</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">createChain</span><span class="params">(String chainName, String chainDefinition)</span></span>;</span><br><span class="line">    <span class="comment">// 添加拦截器到指定的拦截器链</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addToChain</span><span class="params">(String chainName, String filterName)</span></span>;</span><br><span class="line">    <span class="comment">// 添加拦截器（带有配置的）到指定的拦截器链</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">addToChain</span><span class="params">(String chainName, String filterName, String chainSpecificFilterConfig)</span> <span class="keyword">throws</span> ConfigurationException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>最终链式执行过滤器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.core.ApplicationFilterChain#doFilter		--&gt;		org.apache.catalina.core.ApplicationFilterChain#internalDoFilter</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630747870669-5bec76ce-d2b0-481c-9019-a801c96636db.png" alt="img"></p>
<p>执行完过滤器后将调用servlet.service，进而执行controller解析及service等：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630747980904-c4effede-5d19-4eea-99b6-ff24130290fb.png" alt="img"></p>
<p>javax.servlet.http.HttpServlet#service(javax.servlet.ServletRequest, javax.servlet.ServletResponse)：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630748012922-0ad22a7d-cb79-45c0-9f02-3df49c9d1309.png" alt="img"></p>
<p>接下来的SpringMVC controller解析部分详情可参见下面CVE-2020-1957漏洞分析部分。</p>
<h1 id="漏洞环境"><a href="#漏洞环境" class="headerlink" title="漏洞环境"></a>漏洞环境</h1><p>可参考：<a target="_blank" rel="noopener" href="https://github.com/ttestoo/java-sec-study/tree/main/sec-shiro/java-shiro-bypass">https://github.com/ttestoo/java-sec-study/tree/main/sec-shiro/java-shiro-bypass</a></p>
<h1 id="shiro权限绕过-CVE-2020-1957"><a href="#shiro权限绕过-CVE-2020-1957" class="headerlink" title="shiro权限绕过 CVE-2020-1957"></a>shiro权限绕过 CVE-2020-1957</h1><h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><p>Apache Shiro &lt; 1.5.2</p>
<h2 id="利用过程"><a href="#利用过程" class="headerlink" title="利用过程"></a>利用过程</h2><p>1、正常情况下访问/hello/a会进行跳转：<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/a">http://127.0.0.1:9091/hello/a</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630598417492-4561d4bc-9933-433f-957f-cc6ef78f13a6.png" alt="img"></p>
<p>2、可通过分号进行绕过：</p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9091/;/hello/a">http://127.0.0.1:9091/;/hello/a</a></p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9091/aa/..;test=123/admin/index">http://127.0.0.1:9091/aa/..;test=123/admin/index</a></p>
<p>…</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630598478182-9242f04f-91cd-4862-9087-81641d6200a0.png" alt="img"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>shiro filter主要过程上述部分已简单介绍，其中根据分号绕过可初步判断问题可能出现在获取requestURI处，毕竟是拿requestURI和shiro配置的FilterChain进行匹配的，也就是说通过分号使得shiro filter过程的requestURI能绕过shiro的Ant格式的规则匹配；</p>
<p>可以直接在org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain中的String requestURI = getPathWithinApplication(request); 处下断点进行调试：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630762530640-9240f5a9-83f9-41f9-9891-abf1a8248b5e.png" alt="img"></p>
<p>注意这里测试过程中URL为：<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/aa/..;test=123/admin/index">http://127.0.0.1:9091/aa/..;test=123/admin/index</a></p>
<p>跟进getPathWithinApplication函数，将通过WebUtils.<em>getPathWithinApplication –&gt;</em>  WebUtils.getRequestUri <em>获取requestURI：</em></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630762717437-9403cbc3-dd56-4bc4-8d51-7cb65e28b9ec.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630809693985-1a62aed9-2987-4f6c-8df6-b5492f8f5aea.png" alt="img"></p>
<p>最终还是通过request.getRequestURI获取请求中的URI，即：/aa/..;test=123/admin/index</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630809932017-a60478de-c6e6-47f3-bc8f-25cc7b5a1d4d.png" alt="img"></p>
<p>获取到请求中的URI后，将通过org.apache.shiro.web.util.WebUtils#normalize进行标准化处理，其中参数调用了decodeAndCleanUriString函数处理，在decodeAndCleanUriString中可以清晰的看到根据 ; 对uri进行了分割，并获取到 ; 之前的部分，即/aa/..</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630810346400-879eb414-cd8f-4130-a358-0315b2784e05.png" alt="img"></p>
<p>且在normalize函数中，主要标准化处理内容如下：</p>
<ul>
<li><p>\ –&gt; /</p>
</li>
<li><p>// –&gt; /</p>
</li>
<li><p>/./ –&gt; /</p>
</li>
<li><p>/../ –&gt; /</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title">normalize</span><span class="params">(String path, <span class="keyword">boolean</span> replaceBackSlash)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (path == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Create a place for the normalized path</span></span><br><span class="line">        String normalized = path;</span><br><span class="line">		</span><br><span class="line">        <span class="keyword">if</span> (replaceBackSlash &amp;&amp; normalized.indexOf(<span class="string">&#x27;\\&#x27;</span>) &gt;= <span class="number">0</span>)</span><br><span class="line">            normalized = normalized.replace(<span class="string">&#x27;\\&#x27;</span>, <span class="string">&#x27;/&#x27;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (normalized.equals(<span class="string">&quot;/.&quot;</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;/&quot;</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add a leading &quot;/&quot; if necessary</span></span><br><span class="line">        <span class="keyword">if</span> (!normalized.startsWith(<span class="string">&quot;/&quot;</span>))</span><br><span class="line">            normalized = <span class="string">&quot;/&quot;</span> + normalized;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resolve occurrences of &quot;//&quot; in the normalized path</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = normalized.indexOf(<span class="string">&quot;//&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            normalized = normalized.substring(<span class="number">0</span>, index) +</span><br><span class="line">                    normalized.substring(index + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resolve occurrences of &quot;/./&quot; in the normalized path</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = normalized.indexOf(<span class="string">&quot;/./&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            normalized = normalized.substring(<span class="number">0</span>, index) +</span><br><span class="line">                    normalized.substring(index + <span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Resolve occurrences of &quot;/../&quot; in the normalized path</span></span><br><span class="line">        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">            <span class="keyword">int</span> index = normalized.indexOf(<span class="string">&quot;/../&quot;</span>);</span><br><span class="line">            <span class="keyword">if</span> (index &lt; <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">if</span> (index == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> (<span class="keyword">null</span>);  <span class="comment">// Trying to go outside our context</span></span><br><span class="line">            <span class="keyword">int</span> index2 = normalized.lastIndexOf(<span class="string">&#x27;/&#x27;</span>, index - <span class="number">1</span>);</span><br><span class="line">            normalized = normalized.substring(<span class="number">0</span>, index2) +</span><br><span class="line">                    normalized.substring(index + <span class="number">3</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Return the normalized path that we have completed</span></span><br><span class="line">        <span class="keyword">return</span> (normalized);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>由于此时传入的为经过decodeAndCleanUriString处理后的值（/aa/..），所以这里经过normalize处理后结果不变：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630810879658-6b556d3b-a3b0-4d1c-8b65-465ef7cede1b.png" alt="img"></p>
<p>也就是说此时通过WebUtils.getRequestUri获取到的requestUri的值为/aa/..</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630810949737-cb56d03b-6473-493d-a5f2-b88f0ad64bd2.png" alt="img"></p>
<p>且getPathWithinApplication后的值也为/aa/..</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811094176-66d3450e-57ff-4e4d-aee4-c2415e56c08c.png" alt="img"></p>
<p>接下来将对requestURI和在shiro配置文件中配置的过滤规则filterChains进行匹配，则/aa/..不会和任何规则匹配成功，返回null：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811284815-537bd7e2-85b4-4377-9221-f42c5b2ca665.png" alt="img"></p>
<p>至此，我们通过在请求url中添加 ; 成功绕过了shiro的filter过滤匹配，并成功进入SpringMVC controller解析过程，其中入口为SpringMVC的DispatcherServlet.doService()：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">org.apache.catalina.core.ApplicationFilterChain#internalDoFilter --&gt;  javax.servlet.Servlet#service --&gt; javax.servlet.http.HttpServlet#service --&gt; javax.servlet.http.HttpServlet#doGet --&gt; org.springframework.web.servlet.FrameworkServlet#processRequest --&gt; </span><br><span class="line">org.springframework.web.servlet.DispatcherServlet#doService  --&gt;  </span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811428049-15663115-be70-4f2d-ba24-666150d9c746.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811448669-b4aeb01a-827c-4092-a470-1d3bc08fa14b.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811624029-06a2480f-8ff0-4c6f-96b6-2f5904c8288f.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811689283-2290f02b-09c1-4985-b2c1-51cdb50ed836.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630811708232-9b04ba5d-e375-44de-8c35-43251c2934a2.png" alt="img"></p>
<p>在DispatcherServlet.doService中将调用核心的doDispatch方法进行下一步处理：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630812974042-0739a060-658e-457a-bc3e-0f0602260706.png" alt="img"></p>
<p>其中doDispatch主要处理逻辑如下：</p>
<ol>
<li><p>checkMultipart 检查是不是文件上传请求，如果是，则对当前 request 重新进行包装，如果不是，则直接将参数返回；</p>
</li>
<li><p>根据当前请求，调用 getHandler 方法获取请求处理器，如果没找到对应的请求处理器，则调用 noHandlerFound 方法抛出异常或者给出 404；</p>
</li>
<li><p>getHandlerAdapter 方法，根据当前的处理器找到处理器适配器；</p>
</li>
<li><p>然后处理 GET 和 HEAD 请求头的 Last_Modified 字段。当浏览器第一次发起 GET 或者 HEAD 请求时，请求的响应头中包含一个 Last-Modified 字段，这个字段表示该资源最后一次修改时间，以后浏览器再次发送 GET、HEAD 请求时，都会携带上该字段，服务端收到该字段之后，和资源的最后一次修改时间进行对比，如果资源还没有过期，则直接返回 304 告诉浏览器之前的资源还是可以继续用的，如果资源已经过期，则服务端会返回新的资源以及新的 Last-Modified；</p>
</li>
<li><p>接下来调用拦截器的 preHandle 方法，如果该方法返回 false，则直接 return 掉当前请求；</p>
</li>
<li><p>接下来执行 ha.handle 去调用真正的请求，获取到返回结果 mv；</p>
</li>
<li><p>接下来判断当前请求是否需要异步处理，如果需要，则直接 return 掉；如果不需要异步处理，则执行 applyDefaultViewName 方法，检查当前 mv 是否没有视图，如果没有（例如方法返回值为 void），则给一个默认的视图名；</p>
</li>
<li><p>processDispatchResult 方法对执行结果进行处理，包括异常处理、渲染页面以及执行拦截器的 afterCompletion 方法都在这里完成；</p>
</li>
<li><p>最后在 finally 代码块中判断是否开启了异步处理，如果开启了，则调用相应的拦截器；如果请求是文件上传请求，则再调用 cleanupMultipart 方法清除文件上传过程产生的一些临时文件。</p>
</li>
</ol>
<p>其中我们关心的是获取请求处理器的过程，即getHandler方法实现细节：</p>
<p>首先Spring会循环所有注册的HandlerMapping并返回第一个匹配的HandlerExecutionChain：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814032639-f5384d69-548c-4915-885c-31f826e6f859.png" alt="img"></p>
<p>对于mapping为RequestMappingHandlerMapping时，则会调用org.springframework.web.servlet.handler.AbstractHandlerMapping#getHandler进行获取对应的handler，</p>
<p>在getHandler中调用getHandlerInternal方法，并在其中进行调用getLookupPathForRequest–&gt;getPathWithinServletMapping解析请求路径lookupPath：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814270890-44405c4d-f4b9-47aa-b06b-b1d3ec5bbbd1.png" alt="img"></p>
<p>对于getPathWithinServletMapping中首先通过getPathWithinApplication获取请求URI在web应用中的路径，其中经过如下调用链：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630816294063-b78527a9-edf2-4d0e-8c9e-eee4f42fdbdd.png" alt="img"></p>
<p>最终在org.springframework.web.util.UrlPathHelper#getRequestUri中通过request.getRequestURI()获取请求的uri，即/aa/..;test=123/admin/index，并通过decodeAndCleanUriString方法对uri进行处理：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814552407-1b27fd57-a556-4d2d-9c66-c5e91c488858.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814571335-e2e07b55-4482-4841-926d-13d5065b460e.png" alt="img"></p>
<p>decodeAndCleanUriString方法中主要做了三件事：</p>
<ol>
<li>调用removeSemicolonContent方法对uri进行处理，其中将分号及后面的key-value进行了去除得到新的requestUri为/aa/../admin/index：</li>
</ol>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630814649876-ba27a14c-84b0-4bdd-8e20-17008abd1635.png" alt="img"></p>
<ol>
<li>通过调用decodeRequestString进行URL解码：</li>
</ol>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630815007728-c38c58ba-f7c3-4841-956b-e5028e47109c.png" alt="img"></p>
<ol>
<li>通过调用getSanitizedPath将//替换为/：</li>
</ol>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630815019684-7b0f5c02-5b48-484d-8ed5-1bb2eb6ed332.png" alt="img"></p>
<p>至此经过decodeAndCleanUriString方法处理后最终获取到的uri为/aa/../admin/index，即getPathWithinApplication返回的结果pathWithinApp的值也为/aa/../admin/index：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630815090450-f094f3f2-a50c-4d2f-88e7-45654e8d571c.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630816436686-6e9f82b5-e84e-4652-a15e-468f6e2d8d94.png" alt="img"></p>
<p>接下来回到getPathWithinServletMapping中，此时pathWithinApp值为/aa/../admin/index，servletPath为/admin/index，正常情况下将通过getRemainingPath方法将pathWithinApp中servletPath给截取掉，但此时由于两者值无法截取成功返回为null：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827548330-2d757707-5a2e-4869-9664-78844963a702.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827589372-af31f5c6-ce38-47f5-be95-1a557000ade1.png" alt="img"></p>
<p>由于path为null，则进入else这种特殊情况，最终返回servletPath，即/admin/index：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827738887-b16a24c8-efaf-47c9-aff1-d81d040f440c.png" alt="img"></p>
<p>即最终获取到的lookupPath值为/admin/index，并根据lookupPath的值寻找相对应的handlerMethod为com.ttestoo.bypass.controller.LoginController#admin_index()：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630827874273-60cc455e-5d29-4744-b8e5-7a7c5f04b4a4.png" alt="img"></p>
<p>至此，SpringMVC中获取handler的过程已结束，成功获取到/admin/index相对应的handler方法，并将继续获取HandlerAdapter，并执行HandlerAdapter的handle方法利用反射机制执行/admin/index相对应的controller方法com.ttestoo.bypass.controller.LoginController#admin_index()：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630828216926-97b8f1d8-a233-4852-85ec-6100b1695544.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630828309858-4c7c4de8-c44b-4281-8f82-ff557a9eb5b3.png" alt="img"></p>
<p><strong>总结：</strong></p>
<p>当我们发起请求<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/aa/..;test=123/admin/index%E6%97%B6%EF%BC%8C%E7%BB%8F%E8%BF%87shiro">http://127.0.0.1:9091/aa/..;test=123/admin/index时，经过shiro</a> filter进行权限校验，此时shiro解析到的路径为/aa/..不会和任何规则匹配成功，从而通过了shiro的权限校验；</p>
<p>接下来会由springmvc进行controller解析，此时springmvc解析到的路径为/admin/index，并获取到/admin/index对应的handler方法admin_index，从而正常的执行service并得到最终的响应。</p>
<p><strong>漏洞本质：</strong></p>
<p>当路径中包含特殊字符时，shiro解析得到的路径和SpringMVC解析得到的路径不一致，导致可正常通过shiro的权限校验并正常的完成service的执行获取执行结果。</p>
<h2 id="利用场景"><a href="#利用场景" class="headerlink" title="利用场景"></a>利用场景</h2><p>在实际场景中每个API会通过网关层统一校验或@RequiresPermissions注解等方式校验所需访问权限，此漏洞仅能绕过shiro全局的Filter校验，无法绕过API配置的访问权限；</p>
<p>个人理解此问题在实战中利用场景相对有限。</p>
<h2 id="修复方式"><a href="#修复方式" class="headerlink" title="修复方式"></a>修复方式</h2><p>根据官方commit记录，可知在1.5.2开始，在org.apache.shiro.web.util.WebUtils#getRequestUri中获取uri的方式从request.getRequestURI()换成了request.getContextPath()+request.getServletPath()+request.getPathInfo()组合的方式：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630831911543-0b43ee1e-c97e-4382-9741-fc73e15343c1.png" alt="img"></p>
<p>此时请求<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/aa/..;test=123/admin/index%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84url%E4%B8%BA/admin/index%EF%BC%8C%E6%97%A0%E6%B3%95%E7%BB%95%E8%BF%87shiro%E7%9A%84%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C%EF%BC%9A">http://127.0.0.1:9091/aa/..;test=123/admin/index获取到的url为/admin/index，无法绕过shiro的权限校验：</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630832201301-def312c4-e2c9-440b-9470-f653d11e9696.png" alt="img"></p>
<h1 id="shiro权限绕过-CVE-2020-11989"><a href="#shiro权限绕过-CVE-2020-11989" class="headerlink" title="shiro权限绕过 CVE-2020-11989"></a>shiro权限绕过 CVE-2020-11989</h1><h2 id="利用条件-1"><a href="#利用条件-1" class="headerlink" title="利用条件"></a>利用条件</h2><p>主要是针对CVE-2020-1957修复后的绕过探索，主要两种方式：</p>
<ul>
<li>URL双编码：Apache Shiro = 1.5.2  &amp;  controller需为类似”/hello/{page}”的方式</li>
<li>分号绕过：Apache Shiro &lt; 1.5.3    &amp;  server.servlet.context-path不为根/</li>
</ul>
<h2 id="利用过程-1"><a href="#利用过程-1" class="headerlink" title="利用过程"></a>利用过程</h2><h3 id="URL双编码"><a href="#URL双编码" class="headerlink" title="URL双编码"></a>URL双编码</h3><p>shiro版本需为1.5.2，访问<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/test%EF%BC%8C%E8%A2%ABshiro%E6%9D%83%E9%99%90%E6%A0%A1%E9%AA%8C%E6%8B%A6%E6%88%AA%EF%BC%9A">http://127.0.0.1:9091/hello/test，被shiro权限校验拦截：</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630940489631-023496e1-da98-4daa-86b7-4e2d53939ba7.png" alt="img"></p>
<p>访问<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/te%2fst">http://127.0.0.1:9091/hello/te%25%32%66st</a>可直接绕过权限校验：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630940471598-992e754e-ad27-42b5-ae86-7b79efaf47d6.png" alt="img"></p>
<h3 id="分号绕过"><a href="#分号绕过" class="headerlink" title="分号绕过"></a>分号绕过</h3><p>需要配置server.servlet.context-path：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">server.servlet.context-path=/test</span><br></pre></td></tr></table></figure>

<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9091/test/hello/test">http://127.0.0.1:9091/test/hello/test</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943081582-4a5406f7-7533-4e7a-a414-f4314b535385.png" alt="img"></p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9091/a/..;a=1/test/hello/test">http://127.0.0.1:9091/a/..;a=1/test/hello/test</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943069710-d91ad7b5-98ce-4864-8e06-81a410b061ed.png" alt="img"></p>
<h2 id="漏洞分析-1"><a href="#漏洞分析-1" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="URL双编码分析"><a href="#URL双编码分析" class="headerlink" title="URL双编码分析"></a>URL双编码分析</h3><p>首先发起http请求时，若url中存在URL编码字符，则会被容器进行一次URL解码，此时/hello/te%25%32%66st –&gt; /hello/te%2fst，接下来则同CVE-2020-1957过程一样，在shiro处理过程中会在org.apache.shiro.web.util.WebUtils#getPathWithinApplication中通过<em>getRequestUri</em>函数获取uri：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630940944021-d49d2cef-30eb-4cb0-a7a4-dc0603c17fd8.png" alt="img"></p>
<p>在org.apache.shiro.web.util.WebUtils#getRequestUri中首先通过request.getContextPath()+request.getServletPath()+request.getPathInfo()组合的方式获取uri为：//hello/te%2fst</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941027724-973768dc-9e6a-46b0-b481-808a3b53f17f.png" alt="img"></p>
<p>接着在进入normalize函数进行格式化处理时，传入的参数经过了<em>decodeAndCleanUriString</em>方法的处理，其中通过调用org.apache.shiro.web.util.WebUtils#decodeRequestString方法，利用URLDecoder.<em>decode</em>进行了URL解码为：//hello/te/st</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941223066-8d5d3e15-7452-49a0-b799-145565974c95.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941153275-fc2938c5-1511-4b06-97c1-350a73103326.png" alt="img"></p>
<p>继续进入normalize函数，将//替换为/，最终获取到的uri为：/hello/te/st</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630941324744-5c33ef7a-a9ab-4eaf-848d-eb3724832e01.png" alt="img"></p>
<p>接下来就同上面shiro过程一致了，/hello/te/st不会和任何的规则匹配，成功解析controller并执行相对应的service获取响应结果：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630942588039-62813c12-4dce-4a19-9375-c57a7f035d18.png" alt="img"></p>
<p>补充，在1.5.1及之前版本中，获取uri采用request.getRequestURI方式，获取到的为URL双编码的值，shiro进行一次解码并格式化处理后为/hello/te%2fst，则会和/hello/*进行匹配：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630942848484-fa4eaa47-4186-4d97-978e-318228a8fc9f.png" alt="img"></p>
<h3 id="分号绕过分析"><a href="#分号绕过分析" class="headerlink" title="分号绕过分析"></a>分号绕过分析</h3><p>当请求为<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/a/..;a=1/test/hello/test%E6%97%B6%EF%BC%8C">http://127.0.0.1:9091/a/..;a=1/test/hello/test时，</a></p>
<p>同URL双编码主要区别在经过request.getContextPath()+request.getServletPath()+request.getPathInfo()组合获取到的uri为：/a/..;a=1/test//hello/test</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">request.getContextPath() --&gt; /a/..;a=<span class="number">1</span>/test</span><br><span class="line">request.getServletPath() --&gt; /hello/test</span><br><span class="line">request.getPathInfo() --&gt; <span class="keyword">null</span></span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943377680-412a48a6-4637-4769-9ff8-1c92799cd8b1.png" alt="img"></p>
<p>接着经过org.apache.shiro.web.util.WebUtils#decodeAndCleanUriString处理后，会根据 ; 进行分割，最终uri结果为：/a/..</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630943877599-043d68cf-fa55-41d7-ad5a-513391047a04.png" alt="img"></p>
<p>从而绕过shiro的权限校验，而接下来则和cve-2020-1957流程一致，springmvc会将 ; 进行剔除，最终根据/a/../test/hello/test，即/test/hello/test成功解析controller并执行service获取响应结果：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630944025834-d16b0083-2bdc-4ae8-bb0d-fa72de871d7b.png" alt="img"></p>
<h2 id="修复方式-1"><a href="#修复方式-1" class="headerlink" title="修复方式"></a>修复方式</h2><p>在1.5.3中，获取uri方式改成了<em>getServletPath</em>(request) + <em>getPathInfo</em>(request)组合的方式，且去除了解码过程：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945224378-2d1e0b77-3a46-45b0-9be4-e1de4c7dd9f2.png" alt="img"></p>
<p>此时，同样的请求<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/a/..;a=1/test/hello/test%EF%BC%8C%E8%8E%B7%E5%8F%96%E5%88%B0%E7%9A%84requestURI%E4%B8%BA%EF%BC%9A/hello/test">http://127.0.0.1:9091/a/..;a=1/test/hello/test，获取到的requestURI为：/hello/test</a></p>
<p>请求<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/te%2fst">http://127.0.0.1:9091/hello/te%25%32%66st</a>获取到的requestURI为：/hello/te%27st</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945471480-9b2c69b6-7236-45b2-af8b-bb738eca964e.png" alt="img"></p>
<h1 id="shiro权限绕过-CVE-2020-13933"><a href="#shiro权限绕过-CVE-2020-13933" class="headerlink" title="shiro权限绕过 CVE-2020-13933"></a>shiro权限绕过 CVE-2020-13933</h1><h2 id="利用条件-2"><a href="#利用条件-2" class="headerlink" title="利用条件"></a>利用条件</h2><p>Apache shiro&lt;=1.5.3 即 Apache Shiro &lt; 1.6.0</p>
<p>controller需为类似”/hello/{page}”的方式</p>
<h2 id="利用过程-2"><a href="#利用过程-2" class="headerlink" title="利用过程"></a>利用过程</h2><p><a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/test">http://127.0.0.1:9091/hello/test</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945918658-bc68c88c-1bbd-4399-a165-0c2308f7f888.png" alt="img"></p>
<p><a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/%3btest">http://127.0.0.1:9091/hello/%3btest</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945886978-5a1d43ef-4ad2-4fbd-b8a7-8a80a0dc96d5.png" alt="img"></p>
<h2 id="漏洞分析-2"><a href="#漏洞分析-2" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>当发起请求<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/%3btest%E6%97%B6%EF%BC%8C">http://127.0.0.1:9091/hello/%3btest时，</a></p>
<p>首先容器会进行URL解码，/hello/%3btest –&gt; /hello/;test</p>
<p>进入shiro处理，org.apache.shiro.web.util.WebUtils#getPathWithinApplication中最终结果即requestURI为/hello/：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630946332455-87612f5b-4980-4311-8cef-d7341c417640.png" alt="img"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">getServletPath(request) --&gt; /hello/;<span class="function">test</span></span><br><span class="line"><span class="function"><span class="title">getPathInfo</span><span class="params">(request)</span> --&gt; &quot;&quot;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">removeSemicolon中根据</span>;进行分割</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630946573355-ad67852b-6b2a-45e3-a820-9b9f9d91f063.png" alt="img"></p>
<p>而/hello/不会和/hello/*匹配，顺利进入controller解析并执行service获取响应结果：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1630945886978-5a1d43ef-4ad2-4fbd-b8a7-8a80a0dc96d5.png" alt="img"></p>
<h2 id="修复方式-2"><a href="#修复方式-2" class="headerlink" title="修复方式"></a>修复方式</h2><p>在1.6.0中，执行shiro过滤器时增加了preHandle方法进行判断是否继续执行：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631015122689-9c983628-67d6-429a-967e-99b8241626ff.png" alt="img"></p>
<p>判断内容主要为：若请求URI中包含分号、反斜杠、非ASCII字符（均可配置），则直接响应400</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631016774926-e0e9794a-c036-4504-864c-0724ca37a648.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631017071477-240b1685-4392-4189-9005-958d8ab598a6.png" alt="img"></p>
<p>核心逻辑均在新增的类org.apache.shiro.web.filter.InvalidRequestFilter中：<a target="_blank" rel="noopener" href="https://shiro.apache.org/static/1.6.0/apidocs/org/apache/shiro/web/filter/InvalidRequestFilter.html">https://shiro.apache.org/static/1.6.0/apidocs/org/apache/shiro/web/filter/InvalidRequestFilter.html</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631016949953-06a618cd-7d58-470b-b248-c494fc7cfe09.png" alt="img"></p>
<h1 id="shiro权限绕过-CVE-2020-17523"><a href="#shiro权限绕过-CVE-2020-17523" class="headerlink" title="shiro权限绕过 CVE-2020-17523"></a>shiro权限绕过 CVE-2020-17523</h1><h2 id="利用条件-3"><a href="#利用条件-3" class="headerlink" title="利用条件"></a>利用条件</h2><p>Apache Shiro &lt; 1.7.1</p>
<p>controller需为类似”/hello/{page}”的方式</p>
<h2 id="利用过程-3"><a href="#利用过程-3" class="headerlink" title="利用过程"></a>利用过程</h2><h3 id="空格绕过"><a href="#空格绕过" class="headerlink" title="空格绕过"></a>空格绕过</h3><p>1、<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/test">http://127.0.0.1:9091/hello/test</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631017977165-d54f4233-14af-4e29-8d1a-9a8f90ec19f1.png" alt="img"></p>
<p>2、<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/">http://127.0.0.1:9091/hello/%20</a></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631017989869-461680d9-2844-4576-aa34-8bf6c36856e1.png" alt="img"></p>
<h3 id="西式句号-全路径绕过"><a href="#西式句号-全路径绕过" class="headerlink" title="西式句号 全路径绕过"></a>西式句号 全路径绕过</h3><p>需配置开启全路径匹配：</p>
<p>1、<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/">http://127.0.0.1:9091/hello/</a>.</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032985598-c1571efc-1430-4ec5-8569-13b46c2e000b.png" alt="img"></p>
<h2 id="漏洞分析-3"><a href="#漏洞分析-3" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><h3 id="空格绕过-1"><a href="#空格绕过-1" class="headerlink" title="空格绕过"></a>空格绕过</h3><p>当发起<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/">http://127.0.0.1:9091/hello/%20</a>请求时，</p>
<p>首先经过容器URL解码，/hello/%20 –&gt; /hello/空格</p>
<p>发现在shiro进行匹配过程中，/hello/* 和 /hello/空格 不匹配：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631031284766-7164c5c7-22c1-4dfa-9f44-ad509acc3ea1.png" alt="img"></p>
<p>在org.apache.shiro.util.AntPathMatcher#doMatch函数中，/hello/* 和 /hello/空格 经过<em>tokenizeToStringArray</em>函数处理后的结果中/hello空格仅剩/hello：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631030626922-0b1a9ad0-4566-4348-b292-5fa49af55b7b.png" alt="img"></p>
<p>跟进<em>tokenizeToSt**ringArray</em>方法可知，调用过程中，trimTokens参数值为true：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631030678981-ed418be6-7f82-40bf-a5fa-0b4ba1f73d4b.png" alt="img"></p>
<p>而当trimTokens为true时，则会调用trim()，此时/hello/后面的空格将会被丢弃：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631030734899-ac7be7be-06e1-430a-af66-acd42f6f15b3.png" alt="img"></p>
<p>在接下来的判断过程中，匹配结果为false，即/hello/* 和 /hello/空格 不匹配从而导致shiro的权限绕过：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631031176098-38e463df-f41a-47c9-9ee8-7de8e5c35d6b.png" alt="img"></p>
<h3 id="西式句号-全路径绕过-1"><a href="#西式句号-全路径绕过-1" class="headerlink" title="西式句号 全路径绕过"></a>西式句号 全路径绕过</h3><p>当请求<a target="_blank" rel="noopener" href="http://127.0.0.1:9091/hello/.%E6%97%B6%EF%BC%8C">http://127.0.0.1:9091/hello/.时，</a></p>
<p>首先经过org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getPathWithinApplication处理时，会被<em>normalize</em>函数将/hello/.最后面的 . 删除掉，最终requestURI为/hello/：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631033732679-a4573a8c-d7bd-4a66-870b-88150f854011.png" alt="img"></p>
<p>在org.apache.shiro.web.filter.mgt.PathMatchingFilterChainResolver#getChain处理过程中，由于此时requestURI以/结尾，则将会把最后一个/删除，变成/hello：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631031744667-66687cb2-cbb1-4b5d-be6c-dfec6b0d648a.png" alt="img"></p>
<p>而/hello和/hello/*不匹配导致shiro权限绕过：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032096847-7a430343-9821-4683-ae80-09d9a11988b6.png" alt="img"></p>
<p>但是，此时SpringMVC进行controller解析时，请求路径为/hello/%2e，spring中.和/默认是作为路径分割符的，不会参与到路径匹配，此时将解析controller失败，返回404:</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032525802-e06e9e7d-8f38-4801-bd27-dba6f81bc6fb.png" alt="img"></p>
<p>即，虽然绕过了shiro的权限校验，但默认无法解析到controller，也就无法执行想要的service；</p>
<p>特殊情况：</p>
<p>当手工配置开启springboot的全路径匹配时，可成功执行：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//开启全路径匹配</span></span><br><span class="line"><span class="meta">@ServletComponentScan</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span> <span class="keyword">implements</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        SpringApplication.run(Application.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder builder)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> builder.sources(Application.class);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (bean <span class="keyword">instanceof</span> RequestMappingHandlerMapping) &#123;</span><br><span class="line">            ((RequestMappingHandlerMapping) bean).setAlwaysUseFullPath(<span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> BeansException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> bean;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631032729912-0ed6f6cf-5e47-43fb-97f4-52bd13eedd7e.png" alt="img"></p>
<h2 id="修复方式-3"><a href="#修复方式-3" class="headerlink" title="修复方式"></a>修复方式</h2><p>1、将tokenizeToStringArray函数的trimTokens参数设置为false，防止空格被抛弃：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631029386444-c211b447-fd1e-431f-afa8-bb5a2598b112.png" alt="img"></p>
<p>2、将剔除结尾/的过程移到匹配的下方：</p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631033244890-a4a94396-3bb2-4880-af91-b22c15d828b0.png" alt="img"></p>
<p><img src="/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/1631033830623-14cd2689-3898-4e84-ac70-29ab899bbdb9.png" alt="img"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>开头所说的利用分号绕过了nginx的403屏蔽，请求到springboot项目后携带分号解析成功，而当使用了shiro 1.6.0后，url中携带分号则直接报错400，原因就很清晰了，因为在1.6.0中增加了org.apache.shiro.web.filter.InvalidRequestFilter类，其中会判断请求中包含分号时响应400状态码；</p>
<p>shiro的权限绕过，本质还是shiro对uri的解析规则和后端开发框架的解析规则不一样所导致。</p>
<h1 id="巨人的肩膀"><a href="#巨人的肩膀" class="headerlink" title="巨人的肩膀"></a>巨人的肩膀</h1><ul>
<li><p><a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce">https://github.com/apache/shiro/commit/3708d7907016bf2fa12691dff6ff0def1249b8ce</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://shiro.apache.org/static/1.6.0/apidocs/org/apache/shiro/web/filter/InvalidRequestFilter.html">https://shiro.apache.org/static/1.6.0/apidocs/org/apache/shiro/web/filter/InvalidRequestFilter.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df">https://github.com/apache/shiro/commit/0842c27fa72d0da5de0c5723a66d402fe20903df</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://shiro.apache.org/security-reports.html">https://shiro.apache.org/security-reports.html</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/">https://xlab.tencent.com/cn/2020/06/30/xlab-20-002/</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/yb6Tb7zSTKKmBlcNVz0MBA">https://mp.weixin.qq.com/s/yb6Tb7zSTKKmBlcNVz0MBA</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://github.com/jweny/shiro-cve-2020-17523">https://github.com/jweny/shiro-cve-2020-17523</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://segmentfault.com/a/1190000039703198">https://segmentfault.com/a/1190000039703198</a></p>
</li>
<li><p>……</p>
</li>
</ul>

    </div>

    
    
    
      

        

<div>
<ul class="post-copyright">
  <li class="post-copyright-author">
    <strong>本文作者： </strong>ttestoo
  </li>
  <li class="post-copyright-link">
    <strong>本文链接：</strong>
    <a href="https://ttestoo.github.io/2021/09/08/Shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" title="Shiro权限绕过漏洞分析">https://ttestoo.github.io/2021/09/08/Shiro权限绕过漏洞分析/</a>
  </li>
  <li class="post-copyright-license">
    <strong>版权声明： </strong>本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/zh-CN" rel="noopener" target="_blank"><i class="fab fa-fw fa-creative-commons"></i>BY-NC-SA</a> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

        

  <div class="followme">
    <p>欢迎关注我的其它发布渠道</p>

    <div class="social-list">

        <div class="social-item">
          <a target="_blank" class="social-link" href="/images/wechat_channel.jpg">
            <span class="icon">
              <i class="fab fa-weixin"></i>
            </span>

            <span class="label">WeChat</span>
          </a>
        </div>
    </div>
  </div>


      <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Shiro/" rel="tag"># Shiro</a>
          </div>

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2021/08/19/SpringBoot-Actuator-SnakeYAML-RCE%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/" rel="prev" title="SpringBoot Actuator SnakeYAML RCE漏洞分析">
      <i class="fa fa-chevron-left"></i> SpringBoot Actuator SnakeYAML RCE漏洞分析
    </a></div>
      <div class="post-nav-item">
    <a href="/2021/09/10/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96-%E5%8F%8D%E5%B0%84/" rel="next" title="Java反序列化-反射">
      Java反序列化-反射 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E8%A8%80"><span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#Shiro-Filter"><span class="nav-text">Shiro Filter</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E7%8E%AF%E5%A2%83"><span class="nav-text">漏洞环境</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2020-1957"><span class="nav-text">shiro权限绕过 CVE-2020-1957</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6"><span class="nav-text">利用条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B"><span class="nav-text">利用过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E5%9C%BA%E6%99%AF"><span class="nav-text">利用场景</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E5%BC%8F"><span class="nav-text">修复方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2020-11989"><span class="nav-text">shiro权限绕过 CVE-2020-11989</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-1"><span class="nav-text">利用条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-1"><span class="nav-text">利用过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#URL%E5%8F%8C%E7%BC%96%E7%A0%81"><span class="nav-text">URL双编码</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8F%B7%E7%BB%95%E8%BF%87"><span class="nav-text">分号绕过</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-1"><span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#URL%E5%8F%8C%E7%BC%96%E7%A0%81%E5%88%86%E6%9E%90"><span class="nav-text">URL双编码分析</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%88%86%E5%8F%B7%E7%BB%95%E8%BF%87%E5%88%86%E6%9E%90"><span class="nav-text">分号绕过分析</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E5%BC%8F-1"><span class="nav-text">修复方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2020-13933"><span class="nav-text">shiro权限绕过 CVE-2020-13933</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-2"><span class="nav-text">利用条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-2"><span class="nav-text">利用过程</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-2"><span class="nav-text">漏洞分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E5%BC%8F-2"><span class="nav-text">修复方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#shiro%E6%9D%83%E9%99%90%E7%BB%95%E8%BF%87-CVE-2020-17523"><span class="nav-text">shiro权限绕过 CVE-2020-17523</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E6%9D%A1%E4%BB%B6-3"><span class="nav-text">利用条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%A9%E7%94%A8%E8%BF%87%E7%A8%8B-3"><span class="nav-text">利用过程</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87"><span class="nav-text">空格绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A5%BF%E5%BC%8F%E5%8F%A5%E5%8F%B7-%E5%85%A8%E8%B7%AF%E5%BE%84%E7%BB%95%E8%BF%87"><span class="nav-text">西式句号 全路径绕过</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90-3"><span class="nav-text">漏洞分析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87-1"><span class="nav-text">空格绕过</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%A5%BF%E5%BC%8F%E5%8F%A5%E5%8F%B7-%E5%85%A8%E8%B7%AF%E5%BE%84%E7%BB%95%E8%BF%87-1"><span class="nav-text">西式句号 全路径绕过</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BF%AE%E5%A4%8D%E6%96%B9%E5%BC%8F-3"><span class="nav-text">修复方式</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-text">总结</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B7%A8%E4%BA%BA%E7%9A%84%E8%82%A9%E8%86%80"><span class="nav-text">巨人的肩膀</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="ttestoo"
      src="/images/avator.jpg">
  <p class="site-author-name" itemprop="name">ttestoo</p>
  <div class="site-description" itemprop="description">不争</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">9</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/ttestoo" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;ttestoo" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:test@qq.com" title="E-Mail → mailto:test@qq.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title"><i class="fa fa-link fa-fw"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://ttestoo.github.io/" title="https:&#x2F;&#x2F;ttestoo.github.io&#x2F;">Title</a>
        </li>
    </ul>
  </div>

      </div>
        <div class="back-to-top motion-element">
          <i class="fa fa-arrow-up"></i>
          <span>0%</span>
        </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2021 – 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">ttestoo</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">51k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">46 分钟</span>
</div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  
  <script>
    (function(){
      var canonicalURL, curProtocol;
      //Get the <link> tag
      var x=document.getElementsByTagName("link");
		//Find the last canonical URL
		if(x.length > 0){
			for (i=0;i<x.length;i++){
				if(x[i].rel.toLowerCase() == 'canonical' && x[i].href){
					canonicalURL=x[i].href;
				}
			}
		}
    //Get protocol
	    if (!canonicalURL){
	    	curProtocol = window.location.protocol.split(':')[0];
	    }
	    else{
	    	curProtocol = canonicalURL.split(':')[0];
	    }
      //Get current URL if the canonical URL does not exist
	    if (!canonicalURL) canonicalURL = window.location.href;
	    //Assign script content. Replace current URL with the canonical URL
      !function(){var e=/([http|https]:\/\/[a-zA-Z0-9\_\.]+\.baidu\.com)/gi,r=canonicalURL,t=document.referrer;if(!e.test(r)){var n=(String(curProtocol).toLowerCase() === 'https')?"https://sp0.baidu.com/9_Q4simg2RQJ8t7jm9iCKT-xh_/s.gif":"//api.share.baidu.com/s.gif";t?(n+="?r="+encodeURIComponent(document.referrer),r&&(n+="&l="+r)):r&&(n+="?l="+r);var i=new Image;i.src=n}}(window);})();
  </script>




  
<script src="/js/local-search.js"></script>













  

  

</body>
</html>
